___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Ediscom Simple Conversion Code",
  "categories": ["ADVERTISING", "MARKETING", "CONVERSIONS"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyVpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDYuMC1jMDAyIDc5LjE2NDQ2MCwgMjAyMC8wNS8xMi0xNjowNDoxNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIDIxLjIgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NTJENEZCQ0FERTNBMTFFQTkwMTE4NTUxMjVFOTUwRjQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NTJENEZCQ0JERTNBMTFFQTkwMTE4NTUxMjVFOTUwRjQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo1MkQ0RkJDOERFM0ExMUVBOTAxMTg1NTEyNUU5NTBGNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo1MkQ0RkJDOURFM0ExMUVBOTAxMTg1NTEyNUU5NTBGNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Psj1mz8AAAoRSURBVHja7F15bBZFFJ+vLaVUqViP0qIVgYpirRYNCBFFAcV4YLwgJGICSkAF8ZY/gCASYjTBE1RUwAQI8cQzxgsVb0VURO4KSAFBpQhSCrT+Xr+3cbvd3W/nm9nv26+dl7wOXWZ3Z95v35v33hyNNTQ0CEPpoywjAgOAAcCQAcAAYMgAYAAwZAAwABgyABgADBkADACGUkM59CMWi0WycdtLRR6Kc8HnMZ8BLqYmg2vBG8Dfg98Dv9Zxs9ifScKnTHSs8UdEAIDAj0LRF3wBC7wXuE3A22vAC8EPAYhNBoBgAu/Igj6f+QwNZrEO/BR4GoD42wDQVOBdUPSz8Skhvq4aPBogvN0qAYCw6aGns6Atk9IpDf2cDZ4AIOpaNAAQOA3o59hMCpVHR6SvX4CvAQjbWwwAEHg+eyiWOekDzo+wyd0CHgwQVmUkAOyh9LOZlJ4SHkpUaBf4UoDwXeQBgMAL2ZT0Z3NS2UICtz3giwHC15ECAAIv4q+7P3MPDnhaIhEIFwCEFZEAYMdJsdX4vXsrywLsYhBWpRMAy6Qc1wrTMMeC32HNTxtZAOwUrZNOAr/BHl1aAdgiWi9RvmkeB45pA2CzaN10HfgeA0DyRKnp9eAfwL+BDyfxjBnQggGpbnhOBgFQz+1cw7wOvJrLzfBmGmwxTAG70iPBVwSMX6jOYtxbgWdVp6pTlhtKyH8QIffQEuxam7DXQTAHkkiZnIriEfBlAW9ZCh6Idx0Ou6P2OKCMO5sq2m8TsCVsEvTasHL4AGKYiGdGOwSoPhntmJZKAHJZKDpTDXVsly1eZ+MtdpORKgIInVG8CS5PUJW+/vPQxq9SmYqowrXOis+cJ+LTguvZLh8WESP080gUr4IHJahK2lmJPvybikhYsAlQpeVo8PvgqigKnwjt2ovictYEP6LZuodS5YYKTWPAUZngs/Ls2LXgtxJUvQ0a0z9VAOjQgOJMCRwYhKHgZQmqzgEI7VIBwC8anpdRST2271exY+BF3cBTUwHATxqeVyQyjADCnxys1fhUuxNaUBlaIGbNiOElW1GUKDxvNTp0Wpq9nELuA63AaMfu9c+JolvcdyWKJT5VvgH3wXPqdXpBOY5rKxUBOCFEwebz80t4rDmByxL+d0cu23rcT0sYHwMvcBMirlFamrye+zyaQFnT0eCnw9QAasC9is88Bp35S0KwHfhrLeExpBOXxTahFmv0sAiIEW4zYby05jMRX+3hRrvB3XHvH2FpgI7VAqXgvyTqPwy+KYVW6mzqJ4Q9CoJc5NCCQ7g+nEwW+AiXe+ljmQ6+OYxB2LJzqtRFsv6uNAwVNDYshLAnuJiiKh8zRDQK950dCgC8qlhVILLrPdO5knkmhDnO5fosEc+Kuppt8BO6ZtDckm/fphiAdE+HPg5hXu/4EClRSHMJ+zzuoVWA14UFgOqCpe4ZBgDRfIBwlospmuhzD82g5YYBwCeKzyyXrE+Z03QfWkQ7cV6CQNu7mKIVPmPd2DAAoBz4AYVnFnDeXSYdEIUpUUo5zHG0jTK6Y3w+kEnsRusDAC+t1WCGzpSNoCOSmRjKbqhdHiSL571ingRmKikNEByMqFBlhgJA9BhAcCYVScheU6XjUf9E3QB8rNiJPpL1V0YIgGM5ZWHXAnLNp/mMH0nPH7suT+fRnV7aPsnnUmbx6KDzvnhfT04RhE6xPNHQrkJU5RShjYdEdu0aUVK3sVHoTroQ7V/qkMmvHoEmjRWno77UnEqi/QGvoLhaoa890KBfAwJAGz1oqjA3NMlD1wtvEMvb9BJlCKGafli1YsOeuSJ3/89NTAmlI3pSesLWTppFe8njDYtRd5gsAH6rIN5S7HJ/CU/ooIivagvnqwe8RVPFyja9oWkxF63OE10LxorigkuaJOhoy+xoR036KL/0eM31AKiHrjGA6B1F/3yQZP2loRn1m8Vy+CuJ4pOcdkNE17bdmmQ6J/MqCnuEfL9PimKqNgDwsh1CLTt6ERqfLVF/WRjCzzle7M0qFxUBq7ftMEJss/1OM3wTHHL5VMSPRnCja2VnzhItxHpFoe+Uv+8tUZ88L+17edsPaBwYcyR8oPKs/CYTNndDqM7ttlN8njBFJwCLFPt/lcQ4sE9DGqQZ5XaWNqPZud3E744P6XaX4Mxr+nKIjBZkJRDKZp9BJwgNk0zbvqndBmXL34JB+5Dj0gSXlIOfvb9PlwYQzVXo/omSZohcvHqd8j9cI/+8Q9ubxQWkBbc6Ps4ffLSAPKLuugBYLITSOTxDJcwQHSXwoU4A/v3GNcjykb7YdnBr4/4CJ93qkn6e4eMRTdQCAISyR3EsGMEHLwWl57UC8C0i17rGXTOBqO7zRu/PjWhhwDCXscDLIxqOfpfq0ACiJxVkUCijBex56UtPwwDVzG5cqlIbIIGyavfLTSdmnGOByzUvLWgTZCzICmgayN6pZEjvCjoYc+g/U6cW1K4RxTXPIsCq91lOslP8tHO6KGvwX9Nd6Vysi/aS5+a1j2CkS2Y1KQ3wQzoIUVh/pUR92slSpRWEFaJ05/2isO4zRMV7xErAXC0OwjRVi+//mS827pgiKur3Bjp85A6Xa4941M1zDt7NBguJ01Ko0nLwWUnKgNaeVgZd2of3DUHxuogeUftL0Y+ttrbSh0xzGmUu9Xdx/WaOTKJknNM0UEAzSaHhFS7JLb/3LdEQCIZBJLORjrYSKI96xtZC3KisATa0KRfSL8nG06wS5c23BXxXPqcoekUMBHISTrZrM9pKK+kognabI6bl76c6tV9KAxyeQLLBEuVUXpAYkGnC/uIwUhSKRO7lQJdUygse9cu8xkBpAPAiGgdmKTR+MPgBiffR7NoAHvy2hSTQGhvTMvZNNv7Rxt/xx0Bc7uGue+WexmsxQaxuFCnSepmTFTp9C4Q7W/K9lNmp5C+Q/n3QirfE/5nUWpvPX8f/F49x47NujRkKvPufMJBEG5f4eHzleO8vdhOkcmhfX44NVPYWTwY/mI49w2ERnzfhderAM+jrGNUxwDINdBSk6l4CMkXv8oGuLYU+Et47Tm/gww/VTJAD8edQjFJsNJmKBeD54C94jjjqXzpNVdJED3k/lKQjwVLKg5a+j/FJv9yJ/s1UNkEOu/wiJZ90Ba0ifuTMDpsNJ0D2Oey4Rdb/uREJJt8jQs2z5WyszRjUF2vSngRKgilgM2uV7RXN7kbyisgl1XZyLoPwjAZNaC10OZ1prTQGOMYD8ipuYlfrgJFvQhqnbQxw0QbaoPGUM1Ax1DQNBO5WtKlho/aTcKEJdOYPrQminYZ0cspuI+/m8ZdlrkP/+wG24InW39OW0yNtg6PlNVilfXC051Ry+D6LrPp+lO24JyyqDWB2aZbBGfhVQwP6xsxf1E4vmb+iZAAwABgyABgADBkADACGDAAGAEMGAAOAIQOAAcBQiug/AQYA2V4/rA3RM6MAAAAASUVORK5CYII\u003d"
  },
  "description": "Ediscom Simple Conversion Code",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "campaign_id",
    "displayName": "Campaign ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "help": "Campaign ID provided in setup phase by Ediscom account"
  },
  {
    "type": "SELECT",
    "name": "action_number",
    "displayName": "Conversion  Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": 1,
        "displayValue": "1"
      },
      {
        "value": 2,
        "displayValue": "2"
      }
    ],
    "simpleValueType": true,
    "defaultValue": 1,
    "help": "User conversion type, available for multi-step conversion funnel. If your  page support a simple user conversion you can use the default value (1).",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "order_id",
    "displayName": "Order ID",
    "simpleValueType": true,
    "canBeEmptyString": true,
    "help": "Unique conversion identifier which must be generated by your landing page and populated for each transaction."
  },
  {
    "type": "SELECT",
    "name": "use_revenue_share",
    "displayName": "Use revenue share",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": 0,
        "displayValue": "No"
      },
      {
        "value": 1,
        "displayValue": "Si"
      }
    ],
    "simpleValueType": true,
    "defaultValue": 0,
    "help": "Enable when using a revenue share agreement with Ediscom."
  },
  {
    "type": "TEXT",
    "name": "commission_amount",
    "displayName": "Commission amount on user purchase",
    "simpleValueType": true,
    "help": "Mandatory when using a revenue share agreement.",
    "defaultValue": 0,
    "valueUnit": "Euro (€)",
    "enablingConditions": [
      {
        "paramName": "use_revenue_share",
        "paramValue": 1,
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "[0-9]+(\\.[0-9]{1,2})?"
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "total_amount",
    "displayName": "Total user purchase amount",
    "simpleValueType": true,
    "help": "Mandatory when using a revenue share agreement.",
    "defaultValue": 0,
    "valueUnit": "Euro (€)",
    "enablingConditions": [
      {
        "paramName": "use_revenue_share",
        "paramValue": 1,
        "type": "EQUALS"
      }
    ],
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "[0-9]+(\\.[0-9]{1,2})?"
        ]
      },
      {
        "type": "NON_EMPTY"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const log = require('logToConsole');
const queryPermission = require('queryPermission');
const makeNumber = require('makeNumber');
const encodeUriComponent = require('encodeUriComponent');
const sendPixel = require('sendPixel');

//My pixel url template
const baseUrlTemplate = 'https://roi.ediscom.it/v2/az[action_number][campaign_id]/';

//Url specific customization
let baseUrl = baseUrlTemplate;
baseUrl = baseUrl.replace('[action_number]', makeNumber(data.action_number));
baseUrl = baseUrl.replace('[campaign_id]', makeNumber(data.campaign_id));
if (data.order_id){
  baseUrl += encodeUriComponent(data.order_id)+'/';
}

//Management of optional revenue share info, if enabled
if (data.use_revenue_share && data.use_revenue_share == '1'){
  //Commission commission amount
  if (makeNumber(data.commission_amount) > 0){
    baseUrl += encodeUriComponent(data.commission_amount)+'/';
  }
  //Total amount
  if (makeNumber(data.total_amount) > 0){
    //If is not available commission amount but only total amount I have to set commission to zero
    if (makeNumber(data.commission_amount) <= 0){
      baseUrl += '0/';
    }
    baseUrl += encodeUriComponent(data.total_amount)+'/';
  }
  
}
log(baseUrl);

// sendPixel
if (queryPermission('send_pixel', baseUrl)) {
  sendPixel(baseUrl);
}

data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 31/8/2020, 14:04:51


